montageDefine("78f4f03","listen/map-changes",{dependencies:["../weak-map","../list","../dict"],factory:function(e,t,n){"use strict";function s(){throw Error("Can't construct. MapChanges is a mixin.")}var a=e("../weak-map"),i=e("../list");n.exports=s,Object.prototype.hasOwnProperty;var r=new a;s.prototype.getAllMapChangeDescriptors=function(){var t=e("../dict");return r.has(this)||r.set(this,t()),r.get(this)},s.prototype.getMapChangeDescriptor=function(e){var t=this.getAllMapChangeDescriptors();return e=e||"",t.has(e)||t.set(e,{willChangeListeners:new i,changeListeners:new i}),t.get(e)},s.prototype.addMapChangeListener=function(e,t,n){!this.isObservable&&this.makeObservable&&this.makeObservable();var s,a=this.getMapChangeDescriptor(t);s=n?a.willChangeListeners:a.changeListeners,s.push(e),this.dispatchesMapChanges=!0;var i=this;return function(){i&&(i.removeMapChangeListener(e,t,n),i=null)}},s.prototype.removeMapChangeListener=function(e,t,n){var s,a=this.getMapChangeDescriptor(t);s=n?a.willChangeListeners:a.changeListeners;var i=s.findLast(e);if(!i)throw Error("Can't remove listener: does not exist.");i["delete"]()},s.prototype.dispatchMapChange=function(e,t,n){var s=this.getAllMapChangeDescriptors(),a="Map"+(n?"WillChange":"Change");s.forEach(function(s,i){if(!s.isActive){s.isActive=!0;var r;r=n?s.willChangeListeners:s.changeListeners;var o="handle"+(i.slice(0,1).toUpperCase()+i.slice(1))+a;try{r.forEach(function(n){if(n[o])n[o](t,e,this);else{if(!n.call)throw Error("Handler "+n+" has no method "+o+" and is not callable");n.call(n,t,e,this)}},this)}finally{s.isActive=!1}}},this)},s.prototype.addBeforeMapChangeListener=function(e,t){return this.addMapChangeListener(e,t,!0)},s.prototype.removeBeforeMapChangeListener=function(e,t){return this.removeMapChangeListener(e,t,!0)},s.prototype.dispatchBeforeMapChange=function(e,t){return this.dispatchMapChange(e,t,!0)}}});