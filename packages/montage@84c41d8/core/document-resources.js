var Montage=require("montage").Montage,Promise=require("core/promise").Promise,URL=require("core/mini-url"),DocumentResources=Montage.specialize({_SCRIPT_TIMEOUT:{value:5e3},_document:{value:null},_resources:{value:null},_preloaded:{value:null},constructor:{value:function DocumentResources(){this.super()}},initWithDocument:{value:function(e){return this.clear(),this._document=e,this}},clear:{value:function(){this._resources=Object.create(null),this._preloaded=Object.create(null)}},_addResource:{value:function(e){this._resources[e]=!0}},hasResource:{value:function(e){return e in this._resources}},isResourcePreloaded:{value:function(e){return this._preloaded[e]===!0}},isResourcePreloading:{value:function(e){return Promise.isPromise(this._preloaded[e])}},setResourcePreloadedPromise:{value:function(e,n){this._preloaded[e]=n}},setResourcePreloaded:{value:function(e){this._preloaded[e]=!0}},getResourcePreloadedPromise:{value:function(e){return this._preloaded[e]}},addScript:{value:function(e){var n=this.normalizeUrl(e.src);return n?this.isResourcePreloaded(n)?Promise.resolve():this.isResourcePreloading(n)?this.getResourcePreloadedPromise(n):this._importScript(e):this._importScript(e)}},_importScript:{value:function(e){var n,s,a=this,t=this._document,o=t.head,i=Promise.defer(),r=e.src;return r?(a._addResource(r),n=function(){a.setResourcePreloaded(r),e.removeEventListener("load",n),e.removeEventListener("error",n),clearTimeout(s),i.resolve()},e.addEventListener("load",n,!1),e.addEventListener("error",n,!1),s=setTimeout(function(){a.setResourcePreloaded(r),i.resolve()},this._SCRIPT_TIMEOUT),this.setResourcePreloadedPromise(r,i.promise)):i.resolve(),o.appendChild(t.createComment("Inserted from FIXME")),o.appendChild(e),i.promise}},addStyle:{value:function(e){var n,s=e.getAttribute("href");if(s=this.normalizeUrl(s)){if(this.hasResource(s))return;this._addResource(s)}n=this._document.head,n.insertBefore(e,n.firstChild)}},normalizeUrl:{value:function(e,n){return URL.resolve(n||"http://",e)}},preloadResource:{value:function(e){return e=this.normalizeUrl(e),this.isResourcePreloaded(e)?Promise.resolve():this.isResourcePreloading(e)?this.getResourcePreloadedPromise(e):this._preloadResource(e)}},_preloadResource:{value:function(e){var n,s,a=this,t=new XMLHttpRequest,o=Promise.defer();return t.open("GET",e),n=function(){a.setResourcePreloaded(e),t.removeEventListener("load",n),t.removeEventListener("error",n),clearTimeout(s),o.resolve()},t.addEventListener("load",n,!1),t.addEventListener("error",n,!1),t.send(),s=setTimeout(function(){a.setResourcePreloaded(e),o.resolve()},this._SCRIPT_TIMEOUT),this.setResourcePreloadedPromise(e,o.promise),o.promise}}},{getInstanceForDocument:{value:function(e){var n=e.__montage_resources__;return n||(n=e.__montage_resources__=(new DocumentResources).initWithDocument(e)),n}}});exports.DocumentResources=DocumentResources;