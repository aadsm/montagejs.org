montageDefine("84c41d8","core/document-resources",{dependencies:["montage","core/promise","core/mini-url"],factory:function(e,n){var s=e("montage").Montage,a=e("core/promise").Promise,t=e("core/mini-url"),o=s.specialize({_SCRIPT_TIMEOUT:{value:5e3},_document:{value:null},_resources:{value:null},_preloaded:{value:null},constructor:{value:function o(){this.super()}},initWithDocument:{value:function(e){return this.clear(),this._document=e,this}},clear:{value:function(){this._resources=Object.create(null),this._preloaded=Object.create(null)}},_addResource:{value:function(e){this._resources[e]=!0}},hasResource:{value:function(e){return e in this._resources}},isResourcePreloaded:{value:function(e){return this._preloaded[e]===!0}},isResourcePreloading:{value:function(e){return a.isPromise(this._preloaded[e])}},setResourcePreloadedPromise:{value:function(e,n){this._preloaded[e]=n}},setResourcePreloaded:{value:function(e){this._preloaded[e]=!0}},getResourcePreloadedPromise:{value:function(e){return this._preloaded[e]}},addScript:{value:function(e){var n=this.normalizeUrl(e.src);return n?this.isResourcePreloaded(n)?a.resolve():this.isResourcePreloading(n)?this.getResourcePreloadedPromise(n):this._importScript(e):this._importScript(e)}},_importScript:{value:function(e){var n,s,t=this,o=this._document,i=o.head,r=a.defer(),l=e.src;return l?(t._addResource(l),n=function(){t.setResourcePreloaded(l),e.removeEventListener("load",n),e.removeEventListener("error",n),clearTimeout(s),r.resolve()},e.addEventListener("load",n,!1),e.addEventListener("error",n,!1),s=setTimeout(function(){t.setResourcePreloaded(l),r.resolve()},this._SCRIPT_TIMEOUT),this.setResourcePreloadedPromise(l,r.promise)):r.resolve(),i.appendChild(o.createComment("Inserted from FIXME")),i.appendChild(e),r.promise}},addStyle:{value:function(e){var n,s=e.getAttribute("href");if(s=this.normalizeUrl(s)){if(this.hasResource(s))return;this._addResource(s)}n=this._document.head,n.insertBefore(e,n.firstChild)}},normalizeUrl:{value:function(e,n){return t.resolve(n||"http://",e)}},preloadResource:{value:function(e){return e=this.normalizeUrl(e),this.isResourcePreloaded(e)?a.resolve():this.isResourcePreloading(e)?this.getResourcePreloadedPromise(e):this._preloadResource(e)}},_preloadResource:{value:function(e){var n,s,t=this,o=new XMLHttpRequest,i=a.defer();return o.open("GET",e),n=function(){t.setResourcePreloaded(e),o.removeEventListener("load",n),o.removeEventListener("error",n),clearTimeout(s),i.resolve()},o.addEventListener("load",n,!1),o.addEventListener("error",n,!1),o.send(),s=setTimeout(function(){t.setResourcePreloaded(e),i.resolve()},this._SCRIPT_TIMEOUT),this.setResourcePreloadedPromise(e,i.promise),i.promise}}},{getInstanceForDocument:{value:function(e){var n=e.__montage_resources__;return n||(n=e.__montage_resources__=(new o).initWithDocument(e)),n}}});n.DocumentResources=o}});