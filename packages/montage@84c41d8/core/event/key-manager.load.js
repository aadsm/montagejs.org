montageDefine("84c41d8","core/event/key-manager",{dependencies:["montage","core/event/event-manager","core/event/mutable-event","core/event/key-manager"],factory:function(e,n){var s=e("montage").Montage,a=e("core/event/event-manager").defaultEventManager,t=e("core/event/mutable-event").MutableEvent,o={backspace:8,tab:9,enter:13,shift:16,control:17,alt:18,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,"delete":46,semicolon:186,colon:186,equal:187,plus:187,comma:188,less:188,minus:189,underscore:189,period:190,greater:190,slash:191,questionmark:191,backtick:192,tilde:192,openingsquarebracket:219,openingcurlybracket:219,backslash:220,pipe:220,closingsquarebracket:221,closingcurlybracket:221,singlequote:222,doublequote:222,clear:12,meta:91,contextmenu:93,numpad0:96,numpad1:97,numpad2:98,numpad3:99,numpad4:100,numpad5:101,numpad6:102,numpad7:103,numpad8:104,numpad9:105,multiply:106,add:107,subtract:109,decimal:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,f13:124,f14:125,f15:126,f16:127,f17:128,f18:129,f19:130,f20:131,f21:132,f22:133,f23:134,f24:135},p=null,i={meta:17,control:57392,f17:63252,f18:63253,f19:63254,f20:63255,f21:63256,f22:63257,f23:63258,f24:63259},l={f13:44,f14:145,f15:19,f16:63251,f17:63252,f18:63253,f19:63254,f20:63255,f21:63256,f22:63257,f23:63258,f24:63259,meta:224},r={cmd:"command",ctl:"control",ctrl:"control",win:"meta",windows:"meta",opt:"alt",option:"alt"},c={meta:{name:"meta",value:1},alt:{name:"alt",value:2},control:{name:"control",value:4},shift:{name:"shift",value:8}},d={semicolon:";",colon:":",equal:"=",plus:"+",comma:",",less:"<",minus:"-",underscore:"_",period:".",greater:">",slash:"/",questionmark:"?",backtick:"`",tilde:"~",openingsquarebracket:"[",openingcurlybracket:"{",backslash:"\\",pipe:"|",closingsquarebracket:"]",closingcurlybracket:"}",singlequote:"'",doublequote:'"',multiply:"*",add:"+",subtract:"-",decimal:".",divide:"/"},h=null,u="keyPress",m="longKeyPress",g="keyRelease",f=n.KeyManager=s.specialize({_keyEventsListenerInstalled:{value:!1},_composerKeyMap:{value:{}},_triggeredKeys:{value:{}},_longPressKeys:{value:{}},_cleanupTimeout:{value:null},_cleanupThreshold:{value:2e3},_longPressThreshold:{value:1e3},longPressThreshold:{get:function(){return this._longPressThreshold},set:function(e){e>0&&e!==this._longPressThreshold&&(this._longPressThreshold=e,this._cleanupThreshold=this._longPressThreshold>this._cleanupThreshold-100?this._longPressThreshold+100:2e3)}},registerKey:{value:function(e){var n,s,a,t,o,p=this._normalizeKeySequence(e.keys),i=this._composerKeyMap,l=!1;if(p){if(n=this._convertKeysToModifiersAndKeyCode(p),s=i[n.modifiers],s||(s=i[n.modifiers]={}),a=s[n.keyCode]){for(o in a)if(t=a[o],t.object===e){t.refCount++,l=!0;break}l||a.push({object:e,refCount:1})}else s[n.keyCode]=[{object:e,refCount:1}];e._modifiers=n.modifiers,e._keyCode=n.keyCode,this._registerListeners()}}},unregisterKey:{value:function(e){var n,s,a,t,o=this._composerKeyMap;if(n=o[e._modifiers]){s=n[e._keyCode];for(t in s)a=s[t],a.object===e&&(a.refCount--,0>=a.refCount&&(s.splice(t,1),0===s.length&&(delete n[e._keyCode],0===Object.keys(n).length&&(delete o[e._modifiers],0===Object.keys(o).length&&this._unregisterListeners()))))}}},constructor:{value:function(){var e,n=navigator.userAgent;if(v&&console.warn("Rather than creating a new KeyManager object, you might want to use the default key manager"),n.match(/ firefox\//i)?this._firefox=!0:n.match(/ appleWebkit\//i)?(this._webkit=!0,n.match(/ chrome\//i)&&(this._chrome=!0)):n.match(/^opera\//i)&&(this._opera=!0),n.match(/macintosh/i)&&(this._mac=!0,this._opera&&(this._operaMac=!0)),c.command=this._mac?c.meta:c.control,this._operaMac)for(e in i)o[e]=i[e];if(this._firefox)for(e in l)o[e]=l[e];p={};for(var s in o){var e=o[s];void 0===p[e]&&(p[e]=s)}h={};for(var s in d){var e=d[s];void 0===h[e]&&(h[e]=s)}this._shiftKey=!1,this._altKey=!1,this._metaKey=!1,this._ctrlKey=!1}},captureKeydown:{value:function(e){var n,s,a,t=!1;this._preprocessKeyEvent(e),a=this._submap,a&&(n=this._keyCode,n&&a[n]&&(t=this._dispatchComposerKeyMatches(a[n],e)),!t&&e.keyIdentifier&&(s=o[e.keyIdentifier.toLowerCase()]||this._decodeKeyIdentifier(e.keyIdentifier),s&&s!==n&&a[s]&&this._dispatchComposerKeyMatches(a[s],e))),this._setupCleanupTimer()}},captureKeypress:{value:function(e){var n,s,a,t=e.charCode,p=!1;this._preprocessKeyEvent(e),a=this._submap,a&&(n=this._keyCode,n&&a[n]&&(p=this._dispatchComposerKeyMatches(a[n],e)),!p&&t&&t!==n&&a[t]&&(p=this._dispatchComposerKeyMatches(a[t],e)),!p&&e.keyIdentifier&&(s=o[e.keyIdentifier.toLowerCase()]||this._decodeKeyIdentifier(e.keyIdentifier),s&&s!==n&&a[s]&&this._dispatchComposerKeyMatches(a[s],e))),this._setupCleanupTimer()}},captureKeyup:{value:function(e){var n,s,a,t,p=e.keyCode,i=0,l=!1;if(this._preprocessKeyEvent(e),s=this._submap,s&&(p=this._keyCode,p&&s[p]&&(l=this._dispatchComposerKeyMatches(s[p],e),i=p),!l&&e.keyIdentifier&&(n=o[e.keyIdentifier.toLowerCase()]||this._decodeKeyIdentifier(e.keyIdentifier),n&&n!==i&&s[n]&&(l=this._dispatchComposerKeyMatches(s[n],e)))),!l)for(t in this._triggeredKeys)a=this._triggeredKeys[t],(a._keyCode==p||a._keyCode==n)&&this._dispatchComposerKeyMatches([a],e);this._cleanup()}},_normalizeKeySequence:{value:function(e){var n,s,a=[c.meta.name,c.alt.name,c.control.name,c.shift.name],t=e.toLowerCase().replace(/ /g,"").replace(/\+\+/g,"+add").split("+"),p=t.length,i=[];for(s=0;p-1>s;s++){if(n=t[s],n=r[n]||n,n=c[n],!n)return console.warn("Invalid key sequence (modifier):",e),null;i.push(n.name)}return i.sort(function(e,n){return a.indexOf(e)-a.indexOf(n)}),n=t[p-1],n.length>1&&!o[n]?(console.warn("Invalid key sequence (key):",e,n),null):i.length?i.join("+")+"+"+n:n}},_preprocessKeyEvent:{value:function(e){var n,s,a=this,t=e.type,p=e.keyCode;this._operaMac&&this._operaModifierTimeout&&(clearTimeout(this._operaModifierTimeout),this._operaModifierTimeout=null),("keydown"==t||"keyup"==t)&&(this._operaMac?(s="keydown"==t,p==o.shift?this._shiftKey=s:p==o.alt?this._altKey=s:p==o.meta?this._mac&&(this._metaKey=s):p==o.control&&(this._ctrlKey=s),"keyup"==t&&(this._operaModifierTimeout=setTimeout(function(){a._shiftKey=!1,a._altKey=!1,a._metaKey=!1,a._ctrlKey=!1,a._operaModifierTimeout=null},this._cleanupThreshold+1e3))):(this._shiftKey=e.shiftKey,this._altKey=e.altKey,this._metaKey=e.metaKey,this._ctrlKey=e.ctrlKey)),this._mac&&this._webkit&&p==o.contextmenu&&(this._metaKey=!1),this._chrome&&(this._shiftKey||p!=o.plus||"U+002B"!=e.keyIdentifier||(e.keyCode=o.add)),this._modifiers=n=(this._shiftKey?c.shift.value:0)+(this._altKey?c.alt.value:0)+(this._metaKey?c.meta.value:0)+(this._ctrlKey?c.control.value:0),this._submap=this._composerKeyMap[n],this._keyCode=e.keyCode,this._keyIdentifier=e.keyIdentifier}},_registerListeners:{value:function(){this._keyEventsListenerInstalled||(window.addEventListener("keydown",this,!0),window.addEventListener("keypress",this,!0),window.addEventListener("keyup",this,!0),this._keyEventsListenerInstalled=!0)}},_unregisterListeners:{value:function(){this._keyEventsListenerInstalled&&(window.removeEventListener("keydown",this,!0),window.removeEventListener("keypress",this,!0),window.removeEventListener("keyup",this,!0),this._keyEventsListenerInstalled=!1)}},_dispatchComposerKeyMatches:{value:function(e,n){var s,o,p,i,l=this,r=!1,c="keyup"==n.type,d="keydown"==n.type,h=c?g:u,f=e.length;for(i=0;f>i&&!r;i++){s=e[i].object||e[i];for(var v=n.target,y=s.element,b=s.element===window;!b&&(b=v===y,v!=document);)v=v.parentElement,v||(v=document);if(b){if(c){if(p=Object.keys(this._triggeredKeys),-1==p.indexOf(s.uuid))continue;s._longPressTimeout&&(clearTimeout(s._longPressTimeout),s._longPressTimeout=null,delete this._longPressKeys[s.uuid])}else{if(d)delete this._triggeredKeys[s.uuid],n.preventDefault();else if(this._triggeredKeys[s.uuid])continue;s._shouldDispatchLongPress&&!s._longPressTimeout&&(s._longPressTimeout=setTimeout(function(){var e;s._longPressTimeout=null,e=document.createEvent("CustomEvent"),e.initCustomEvent(m,!0,!0,null),e.activeElement=n.target,e.identifier=s.identifier,e=t.fromEvent(e),a.activeTarget.dispatchEvent(e),delete l._longPressKeys[s.uuid]},this._longPressThreshold),this._longPressKeys[s.uuid]=s)}o=document.createEvent("CustomEvent"),o.initCustomEvent(h,!0,!0,null),o.activeElement=n.target,o.identifier=s.identifier,o=t.fromEvent(o),this._opera&&(o.type=h),a.activeTarget.dispatchEvent(o),o.defaultPrevented&&n.preventDefault(),o.propagationStopped&&(n.stopPropagation(),r=!0),c?delete this._triggeredKeys[s.uuid]:this._triggeredKeys[s.uuid]=s}}if(r)for(i=c?i:0;f>i;i++)s=e[i].object||e[i],delete this._triggeredKeys[s.uuid],s._longPressTimeout&&(clearTimeout(s._longPressTimeout),s._longPressTimeout=null,delete this._longPressKeys[s.uuid]);return r}},_cleanup:{value:function(){var e,n;this._cleanupTimeout&&clearTimeout(this._cleanupTimeout);for(n in this._triggeredKeys)this._triggeredKeys.hasOwnProperty(n)&&delete this._triggeredKeys[n];for(n in this._longPressKeys)this._longPressKeys.hasOwnProperty(n)&&(e=this._longPressKeys[n],clearTimeout(e._longPressTimeout),e._longPressTimeout=null,delete this._longPressKeys[n]);this._cleanupTimeout=null}},_setupCleanupTimer:{value:function(){var e=this;this._cleanupTimeout&&clearTimeout(this._cleanupTimeout),this._cleanupTimeout=setTimeout(function(){e._cleanup()},this._cleanupThreshold)}},_convertKeysToModifiersAndKeyCode:{value:function(e){var n,s,a,t=0,p=0;for(e=e.toLowerCase().replace(/ /g,"").replace(/\+\+/g,"+add").split("+"),n=e.length,a=0;n-1>a;a++){if(s=e[a],s=r[s]||s,s=c[s],!s)return console.warn("Invalid Key sequence:",e),null;p|=s.value}return s=e[n-1],s=h[s]||s,s=d[s]||s,s.length>1?(t=o[s],s=c[r[s]||s],s&&(p|=s.value)):t=s.toUpperCase().charCodeAt(0),{modifiers:p,keyCode:t}}},_decodeKeyIdentifier:{value:function(e){return e.match(/U\+/)?parseInt(e.substring(2),16):void 0}}}),v=null;s.defineProperty(n,"defaultKeyManager",{get:function(){return v||(v=new f),v}})}});