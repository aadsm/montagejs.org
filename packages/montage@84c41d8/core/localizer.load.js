montageDefine("84c41d8","core/localizer",{dependencies:["montage","core/messageformat","core/logger","core/serialization","core/promise","core/bindings","collections/listen/property-changes","frb/bindings","frb/stringify","frb/expand","frb/scope","core/messageformat-locale"],factory:function(e,n){var t=e("montage").Montage,s=e("core/messageformat"),a=e("core/logger").logger("localizer"),o=e("core/serialization").Serializer,i=e("core/serialization").Deserializer,r=e("core/promise").Promise,l=e("core/bindings").Bindings,p=(e("collections/listen/property-changes"),e("frb/bindings")),c=e("frb/stringify"),d=e("frb/expand"),h=e("frb/scope");s.locale=e("core/messageformat-locale");var u="key",m="default",g="montage_locale",f="locale",v="messages",b="manifest.json",y=function(){return""},w=/^[a-zA-Z]+(?:-[a-zA-Z0-9]+)*$/,_=n.Localizer=t.specialize({constructor:{value:function _(){this.super()}},init:{value:function(e){return this.locale=e||j.locale,this}},initWithMessages:{value:function(e,n){return this.locale=e,this.messages=n,this}},messageFormat:{serializable:!1,value:null},_messages:{value:null},messages:{get:function(){return this._messages},set:function(e){if(this._messages!==e){if(null!=e&&"object"!=typeof e)throw new TypeError(e," is not an object");this._messages=e}}},messagesPromise:{serializable:!1,value:null},_locale:{value:null},locale:{get:function(){return this._locale},set:function(e){if(!w.test(e))throw new TypeError("Language tag '"+e+"' is not valid. It must match http://tools.ietf.org/html/rfc5646 (alphanumeric characters separated by hyphens)");this._locale!==e&&(this._locale=e,this.messageFormat=new s(e))}},_availableLocales:{value:null},availableLocales:{get:function(){return this._availableLocales?this._availableLocales:this._availableLocales=this._manifest.get("files").get(f).get("files").then(function(e){return Object.keys(e)})}},_require:{value:"undefined"!=typeof global?global.require:"undefined"!=typeof window?window.require:null},require:{serializable:!1,get:function(){return this._require},set:function(e){this._require!==e&&(this.__manifest=null,this._require=e)}},__manifest:{value:null},_manifest:{depends:["require"],get:function(){var e=this.require;return e.packageDescription.manifest===!0?this.__manifest?this.__manifest:this.__manifest=e.async(b):r.reject(Error("Package has no manifest. "+e.location+'package.json must contain "manifest": true and '+e.location+b+" must exist"))}},loadMessages:{value:function(e,n){if(!this.require)throw Error("Cannot load messages as",this,"require is not set");null===e&&(e=5e3),this.messages=null;var t=this;this.require;var s=this._manifest;return e&&(s=s.timeout(e)),this.messagesPromise=s.get("files").then(function(e){return t._loadMessageFiles(e)}).then(function(e){return t._collapseMessages(e)}).fail(function(e){throw console.error("Could not load messages for '"+t.locale+"': "+e),e}).then(function(e){return"function"==typeof n&&n(e),e})}},_loadMessageFiles:{value:function(e){var n=this.require;if(!e)return r.reject(Error(n.location+b+" does not contain a 'files' property"));var t,s,o,i,l=[];if(!(f in e))return r.reject(Error("Package does not contain a '"+f+"' directory"));for(t=e[f].files,s=this._locale;""!==s;)t.hasOwnProperty(s)&&(o=t[s].files,(i=v+".js")in o||(i=v+".json")in o?l.push(n.async(f+"/"+s+"/"+i)):a.isDebug&&a.debug(this,"Warning: '"+f+"/"+s+"/' does not contain '"+v+".json' or '"+v+".js'")),s=s.substring(0,s.lastIndexOf("-"));if(!l.length)return r.reject(Error("Could not find any "+v+".json or "+v+".js files"));var p=r.all(l);if(a.isDebug){var c=this;p=p.then(function(e){return a.debug(c,"loaded "+e.length+" message files"),e})}return p}},_collapseMessages:{value:function(e){for(var n={},t=0,s=e.length;s>t;t++){var a=e[t];for(var o in a)o in n||(n[o]=a[o])}return this.messages=n,n}},_compiledMessageCache:{value:Object.create(null)},localizeSync:{value:function(e,n){var t,a,o;if(!e&&!n)throw Error("Key or default message must be truthy, not "+e+" and "+n);if(this._messages&&e in this._messages){if(t=this._messages[e],a=typeof t,"function"===a)return t;if("object"===a){if(!("message"in t))throw Error(t,"does not contain a 'message' property");t=t.message}}else t=n;if(t||(console.warn("No message or default message for key '"+e+"'"),t=e),t in this._compiledMessageCache)return this._compiledMessageCache[t];var i=this.messageFormat.parse(t);return i.program&&i.program.statements&&1===i.program.statements.length&&"string"===i.program.statements[0].type?(o=function(){return t},o.toString=o):o=Function("MessageFormat","return "+this.messageFormat.precompile(i))(s),this._compiledMessageCache[t]=o,o}},localize:{value:function(e,n,t,s){var a,o=this;if(t=t===void 0?!0:t,!this.messagesPromise)return a=r.resolve(this.localizeSync(e,n)),a.then(s),a;var i=function(){var t=o.localizeSync(e,n);return"function"==typeof s&&s(t),t};return t?this.messagesPromise.then(i,i):this.messagesPromise.then(i)}}}),x=_.specialize({init:{value:function(){var e=this.callDelegateMethod("getDefaultLocale");return e||"undefined"==typeof window||(window.localStorage&&(e=window.localStorage.getItem(g)),e=e||window.navigator.userLanguage||window.navigator.language),e=e||"en",this.locale=e,this.loadMessages().done(),this}},_delegate:{value:null},delegate:{get:function(){return this._delegate},set:function(e){this._delegate!==e&&(this._delegate=e,this.init())}},locale:{get:function(){return this._locale},set:function(e){try{Object.getPropertyDescriptor(_,"locale").set.call(this,e)}catch(n){e="en",Object.getPropertyDescriptor(_,"locale").set.call(this,e)}"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem(g,e)}},reset:{value:function(){return"undefined"!=typeof window&&window.localStorage&&window.localStorage.removeItem(g),this.init(),this._locale}}}),j=n.defaultLocalizer=(new x).init();n.localize=j.localize.bind(j);var E=n.Message=t.specialize({constructor:{value:function(){this.defineBinding("_data",{"<-":"_dataObject.toMap()"}),this._data.addMapChangeListener(this,"data")}},init:{value:function(e,n,t){return e&&(this.key=e),n&&(this.defaultMessage=n),t&&(this.data=t),this}},_localizer:{value:j},localizer:{get:function(){return this._localizer},set:function(e){this._localizer!=e&&(this._localizer=e,this._localize())}},_key:{value:null},key:{get:function(){return this._key},set:function(e){this._key!==e&&(this._key=e,this._localize())}},_defaultMessage:{value:null},defaultMessage:{get:function(){return this._defaultMessage},set:function(e){this._defaultMessage!==e&&(this._defaultMessage=e,this._localize())}},_isLocalizeQueued:{value:!1},_localize:{value:function(){if(!this._isLocalizeQueued){this._isLocalizeQueued=!0;var e=this,n=r.defer();this._messageFunction=n.promise,this.localized=this._messageFunction.then(function(n){return n(e._data.toObject())}),r.nextTick(function(){return e._isLocalizeQueued=!1,e._key||e._defaultMessage?(n.resolve(e._localizer.localize(e._key,e._defaultMessage)),void 0):(console.warn("Both key and default message are falsey for",e,"If this is in a repetition this warning can be ignored"),n.resolve(y),void 0)})}}},_messageFunction:{value:r.resolve(y)},_dataObject:{value:null},_data:{value:null},data:{get:function(){return this._data},set:function(e){this._dataObject!==e&&(this._dataObject=e)}},__localizedResolved:{value:""},_localizedDeferred:{value:r.defer()},localized:{get:function(){return this._localizedDeferred.promise},set:function(e){if(e!==this._localized){var n=this,t=r.defer();this._localizedDeferred.resolve(t.promise),e.then(t.resolve,t.reject),t.promise.then(function(e){return n.__localizedResolved=e}).done(),this._localizedDeferred=t}}},handleDataMapChange:{value:function(){this.localized=this._messageFunction.fcall(this._data.toObject())}},serializeSelf:{value:function(){var e={_bindingDescriptors:this._bindingDescriptors};return e.key=this._key,e.defaultMessage=this._defaultMessage,this._localizer!==j&&(e.localizer=this._localizer),e}},serializeForLocalizations:{value:function(e){var n,t,s={};t=p.getBindings(this),t&&t.key?(s[u]={},this._serializeBinding(this,s[u],t.key,e)):s[u]=this._key,t&&t.defaultMessage?(s[m]={},this._serializeBinding(this,s[m],t.defaultMessage,e)):s[m]=this._defaultMessage;var a=p.getBindings(this._data);n=this._data.toObject();for(var o in n)!n.hasOwnProperty(o)||a&&a[".get('"+o+"')"]||(s.data||(s.data={}),s.data[o]=n[o]);for(var i in a){var r=/\.get\('([^']+)'\)/.exec(i)[1];s.data||(s.data={}),s.data[r]={},this._serializeBinding(this._data,s.data[r],a[i],e)}return s}},_serializeBinding:{value:function(e,n,t,s){if(!("serializable"in t)||t.serializable){var a=t.sourceSyntax;if(t.source!==e){var o=s.addObjectReference(t.source),i=new h({type:"component",label:o["@"]});i.components=s,a=d(a,i)}var i=new h;i.components=s;var r=c(a,i);t.twoWay?n["<->"]=r:n["<-"]=r,t.converter?n.converter=t.converter:(n.convert=t.convert,n.revert=t.revert),t.trace&&(n.trace=!0)}}}}),k=function(e,n,t,s,a,o){var i=new E;for(var r in a)"string"==typeof a[r]?i.data.set(r,a[r]):l.defineBinding(i.data,".get('"+r+"')",a[r],{components:o});"object"==typeof t?l.defineBinding(i,"key",t,{components:o}):i.key=t,"object"==typeof s?l.defineBinding(i,"defaultMessage",s,{components:o}):i.defaultMessage=s,l.defineBinding(e,n,{"<-":"__localizedResolved",source:i,serializable:!1})};o.defineSerializationUnit("localizations",function(e,n){var t=p.getBindings(n);if(t){var s;for(var a in t){var o=t[a];if(E.prototype.isPrototypeOf(o.source)){s||(s={});var i=o.source;s[a]=i.serializeForLocalizations(e)}}return s}}),i.defineDeserializationUnit("localizations",function(e,n,t){for(var s in t){var o,i,r=t[s];u in r?(!a.isDebug||m in r||a.debug(this,"Warning: localized property '"+s+"' does not contain a default message property ("+m+"), in ",n),o=r[u],i=r[m],k(n,s,o,i,r.data,e)):console.error("localized property '"+s+"' must contain a key property ("+u+"), in ",t[s])}})}});