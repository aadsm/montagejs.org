var Montage=require("montage").Montage,Target=require("core/target").Target,logger=require("core/logger").logger("mediacontroller"),MediaController=exports.MediaController=Target.specialize({STOPPED:{enumerable:!0,value:0,writable:!1},PLAYING:{enumerable:!0,value:1,writable:!1},PAUSED:{enumerable:!0,value:2,writable:!1},EMPTY:{enumerable:!0,value:3,writable:!1},_TIMEUPDATE_FREQUENCY:{value:.25},_mediaElement:{value:null,enumerable:!1},mediaElement:{get:function(){return this._mediaElement},set:function(e){this._mediaElement=e},enumerable:!1},_mediaSrc:{value:null,enumerable:!1},mediaSrc:{get:function(){return this._mediaSrc},set:function(e){this._mediaSrc=e}},_posterSrc:{value:null},posterSrc:{get:function(){return this._posterSrc},set:function(e){this._posterSrc=e}},_status:{enumerable:!1,value:3},status:{enumerable:!1,get:function(){return this._status},set:function(e){e!==this._status&&(this._status=e,this._dispatchStateChangeEvent())}},_position:{value:null,enumerable:!1},position:{set:function(e,n){this._position=e,n||(this.currentTime=e)},get:function(){return this._position}},_duration:{value:null,enumerable:!1},duration:{set:function(e){return isNaN(e)?(logger.isDebug&&logger.debug("MediaController:setDuration: duration is not valid"),void 0):(logger.isDebug&&logger.debug("MediaController:setDuration: duration="+e),this._duration=e,void 0)},get:function(){return this._duration}},autoplay:{enumerable:!1,value:!0},play:{value:function(){logger.isDebug&&logger.debug("MediaController:play()"),this.mediaElement.play()}},pause:{value:function(){logger.isDebug&&logger.debug("MediaController:pause()"),this.mediaElement.pause()}},playPause:{value:function(){logger.isDebug&&logger.debug("MediaController:playPause");var e=this.status===this.PLAYING;return this.playbackRate=this.mediaElement.defaultPlaybackRate,e?this.pause():this.play(),!e}},_playbackRate:{value:1,enumerable:!1},playbackRate:{get:function(){return this._playbackRate},set:function(e){this._playbackRate!==e&&(this._playbackRate=e,this.mediaElement.playbackRate=this._playbackRate)}},_currentTime:{value:0,enumerable:!1},_updateCurrentTime:{value:!1,enumerable:!1},currentTime:{get:function(){return this.mediaElement.currentTime},set:function(e){try{if(isNaN(this.mediaElement.duration))return logger.error("MediaController:set currentTime: duration is not valid"),void 0;logger.isDebug&&logger.debug("current time:"+this.mediaElement.currentTime+" new time is"+e),this.mediaElement.currentTime=e}catch(n){logger.error("MediaController:Exception in set currentTime"+this.mediaElement.currentTime)}}},rewind:{value:function(){this.status===this.PLAYING&&(logger.isDebug&&logger.debug("MediaController:rewind"),this.playbackRate=-4)}},fastForward:{value:function(){this.status===this.PLAYING&&(logger.isDebug&&logger.debug("MediaController:fastForward"),this.playbackRate=4)}},stop:{value:function(){logger.isDebug&&logger.debug("MediaController:stop"),this.status===this.PLAYING&&(logger.isDebug&&logger.debug("MediaController:stop while PLAYING: will pause"),this.pause()),this.status=this.STOPPED,this.position=0}},fullscreen:{value:function(){this.mediaElement.webkitEnterFullScreen?this.mediaElement.webkitEnterFullScreen():this.mediaElement.webkitRequestFullScreen&&this.mediaElement.webkitRequestFullScreen()}},reset:{value:function(){logger.isDebug&&logger.debug("MediaController:reset"),this.status!==this.STOPPED&&this.stop(),this.mediaElement.removeAttribute("src")}},showPoster:{value:function(){this.mediaElement.poster=this.posterSrc?this.posterSrc:null}},loadMedia:{value:function(){logger.isDebug&&logger.debug("MediaController:loadMedia"),this.mediaElement.src=this.mediaSrc,this._installControlEventHandlers(),this.mediaElement.load()}},toggleRepeat:{value:function(){this.repeat=!this.repeat}},_repeat:{value:!1,enumerable:!1},repeat:{get:function(){return this._repeat},set:function(e){e!==this._repeat&&(this._repeat=e,e?this.mediaElement.setAttribute("loop","true"):this.mediaElement.removeAttribute("loop"),this._dispatchStateChangeEvent())}},volume:{get:function(){return 100*this.mediaElement.volume},set:function(e){var n=e;n===void 0?n=50:n>100?n=100:0>n&&(n=0),this.mediaElement.volume=n/100,this._dispatchStateChangeEvent()}},volumeIncrease:{value:function(){this.volume+=10}},volumeDecrease:{value:function(){this.volume-=10}},toggleMute:{value:function(){this.mute=!this.mute}},mute:{get:function(){return this.mediaElement.muted},set:function(e){e!==this.mediaElement.muted&&(this.mediaElement.muted=e)}},handleLoadedmetadata:{value:function(){return logger.isDebug&&logger.debug("MediaController:handleLoadedmetadata: PLAYING="+(this.status===this.PLAYING)+" duration="+this.mediaElement.duration),isNaN(this.mediaElement.duration)?(logger.isDebug&&logger.debug("MediaController:handleLoadedmetadata: duration is not valid"),void 0):(this.duration=this.mediaElement.duration,this.autoplay?this.play():this.status=this.PAUSED,void 0)}},_lastCurrentTime:{value:0},handleTimeupdate:{value:function(){if(this.status!==this.STOPPED){var e=this.mediaElement.currentTime;Object.getPropertyDescriptor(this,"position").set.call(this,e,!0)}}},handlePlay:{value:function(){logger.isDebug&&logger.debug("MediaController:Play"),this.status=this.PLAYING}},handlePlaying:{value:function(){logger.isDebug&&logger.debug("MediaController:handlePlaying: PLAYING"),this.status=this.PLAYING}},handlePause:{value:function(){this.status!==this.STOPPED?(logger.isDebug&&logger.debug("MediaController:handlePause: PAUSED"),this.status=this.PAUSED):logger.isDebug&&logger.debug("MediaController:handlePause: STOPPED")}},handleEnded:{value:function(){logger.isDebug&&logger.debug("MediaController:handleEnded"),this.status=this.STOPPED,this.mediaElement.pause()}},handleAbort:{value:function(){logger.isDebug&&logger.debug("MediaController:handleAbort: STOPPED"),this.status=this.STOPPED}},handleError:{value:function(e){logger.isDebug&&logger.debug("MediaController:handleError: STOPPED");var n=e.target.error;if(this.status=this.STOPPED,n)switch(n.code){case n.MEDIA_ERR_ABORTED:console.error("You aborted the video playback.");break;case n.MEDIA_ERR_NETWORK:console.error("A network error caused the video download to fail part-way.");break;case n.MEDIA_ERR_DECODE:console.error("The video playback was aborted due to a corruption problem or because the video used features your browser did not support.");break;case n.MEDIA_ERR_SRC_NOT_SUPPORTED:this.mediaElement.src.length>0?console.error("The video at "+this.mediaElement.src+" could not be loaded, either because the server or network failed or because the format is not supported."):console.error("No video has been selected.");break;default:console.error("An unknown error occurred.")}this._isFullScreen=!1}},handleEmptied:{value:function(){logger.isDebug&&logger.debug("MediaController:handleEmptied: STOPPED"),this.status=this.STOPPED}},_dispatchStateChangeEvent:{value:function(){var e=window.document.createEvent("CustomEvent");e.initCustomEvent("mediaStateChange",!0,!0,null),this.dispatchEvent(e)}},_installControlEventHandlers:{value:function(){this.mediaElement.addEventListener("loadedmetadata",this,!1),this.mediaElement.addEventListener("timeupdate",this,!1),this.mediaElement.addEventListener("play",this,!1),this.mediaElement.addEventListener("playing",this,!1),this.mediaElement.addEventListener("pause",this,!1),this.mediaElement.addEventListener("abort",this,!1),this.mediaElement.addEventListener("error",this,!1),this.mediaElement.addEventListener("emptied",this,!1),this.mediaElement.addEventListener("ended",this,!1)}},constructor:{value:function(){this.super()}}});