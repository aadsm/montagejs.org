"use strict";function getModuleRequire(e,n){for(var t=e.resolve(n),s=e.getModuleDescriptor(t);s.redirect||s.mappingRedirect;)s.redirect?t=s.redirect:(e=s.mappingRequire,t=s.mappingRedirect),s=e.getModuleDescriptor(t);return s.require}var Montage=require("montage").Montage,Promise=require("core/promise").Promise,Deserializer=require("core/serialization").Deserializer,ObjectProperty=require("core/meta/object-property").ObjectProperty,Enum=require("core/enum").Enum,BinderModule=require("core/meta/binder"),BlueprintReference=require("core/meta/blueprint-reference").BlueprintReference,PropertyBlueprint=require("core/meta/property-blueprint").PropertyBlueprint,AssociationBlueprint=require("core/meta/association-blueprint").AssociationBlueprint,DerivedPropertyBlueprint=require("core/meta/derived-property-blueprint").DerivedPropertyBlueprint,EventBlueprint=require("core/meta/event-blueprint").EventBlueprint,PropertyValidationRule=require("core/meta/validation-rule").PropertyValidationRule,logger=require("core/logger").logger("blueprint"),Defaults={name:"default",moduleId:"",prototypeName:"",customPrototype:!1},Blueprint=exports.Blueprint=Montage.specialize({FileExtension:{value:".meta"},constructor:{value:function Blueprint(){this.super()}},initWithName:{value:function(e){return this.initWithNameAndModuleId(e,null)}},initWithNameAndModuleId:{value:function(e,n){return this._name=null!==e?e:"default",this.prototypeName=this.name,this.moduleId=n,this.customPrototype=!1,this}},serializeSelf:{value:function(e){e.setProperty("name",this.name),this._binder&&!this.binder.isDefault&&e.setProperty("binder",this._binder,"reference"),e.setProperty("blueprintModuleId",this.blueprintInstanceModuleId),this._parentReference&&e.setProperty("parent",this._parentReference),this._setPropertyWithDefaults(e,"moduleId",this.moduleId),this.prototypeName===this.name&&this._setPropertyWithDefaults(e,"prototypeName",this.prototypeName),this._setPropertyWithDefaults(e,"customPrototype",this.customPrototype),this._propertyBlueprints.length>0&&e.setProperty("propertyBlueprints",this._propertyBlueprints),Object.getOwnPropertyNames(this._propertyBlueprintGroups).length>0&&e.setProperty("propertyBlueprintGroups",this._propertyBlueprintGroups),this._eventBlueprints.length>0&&e.setProperty("eventBlueprints",this._eventBlueprints),this._propertyValidationRules.length>0&&e.setProperty("propertyValidationRules",this._propertyValidationRules)}},deserializeSelf:{value:function(e){this._name=e.getProperty("name");var n=e.getProperty("binder");n&&(this._binder=n),this.blueprintInstanceModuleId=e.getProperty("blueprintModuleId"),this._parentReference=e.getProperty("parent"),this.moduleId=this._getPropertyWithDefaults(e,"moduleId"),this.prototypeName=this._getPropertyWithDefaults(e,"prototypeName"),""===this.prototypeName&&(this.prototypeName=this.name),this.customPrototype=this._getPropertyWithDefaults(e,"customPrototype");var t;t=e.getProperty("propertyBlueprints"),t&&(this._propertyBlueprints=t),t=e.getProperty("propertyBlueprintGroups"),t&&(this._propertyBlueprintGroups=t),t=e.getProperty("eventBlueprints"),t&&(this._eventBlueprints=t),t=e.getProperty("propertyValidationRules"),t&&(this._propertyValidationRules=t)}},_setPropertyWithDefaults:{value:function(e,n,t){t!=Defaults[n]&&e.setProperty(n,t)}},_getPropertyWithDefaults:{value:function(e,n){var t=e.getProperty(n);return t?t:Defaults[n]}},_name:{value:null},name:{get:function(){return this._name}},create:{value:function(e,n){if(e===void 0||Blueprint.prototype.isPrototypeOf(e)){var t=Object.getPrototypeOf(Blueprint).create;return t.call(this,e===void 0?this:e,n)}var s=Montage.create(e,n);return this.ObjectProperty.applyWithBlueprint(s.prototype,this),this.customPrototype=!0,s}},newInstance:{value:function(){var e=this.newInstancePrototype();return e?new e:null}},newInstancePrototype:{value:function(){var e=this;if(this.customPrototype){var n=Promise.defer();return require.async(this.moduleId,function(e){n.resolve(e)}),n.promise.then(function(n){var t=n[e.prototypeName];return t?t:null})}if(exports[e.prototypeName]===void 0){var t=this.parent?this.parent.newInstancePrototype():Montage,s=Montage.create(t,{init:{value:function(){return this}}});this.ObjectProperty.applyWithBlueprint(s.prototype,this),exports[e.prototypeName]=s}var a=exports[e.prototypeName];return a?a:null}},ObjectProperty:{serializable:!1,enumerable:!0,get:function(){return this.binder?this.binder.ObjectProperty:BinderModule.Binder.manager.defaultBlueprintObjectProperty}},blueprintInstanceModuleId:{serializable:!1,value:null},createDefaultBlueprintForObject:{value:function(e){if(e){var n=Montage.getInfoForObject(e).isInstance?Object.getPrototypeOf(e):e,t=Montage.getInfoForObject(n),s=(new Blueprint).initWithNameAndModuleId(t.objectName,t.moduleId);for(var a in n)if("_"!==a.charAt(0)&&n.hasOwnProperty(a)){var o,r=n[a];o=Array.isArray(r)?s.addToManyPropertyBlueprintNamed(a):s.addToOnePropertyBlueprintNamed(a),s.addPropertyBlueprintToGroupNamed(o,t.objectName)}var i=Object.getPrototypeOf(n);return"blueprint"in i?i.blueprint.then(function(e){return s.parent=e,s}):s}return UnknownBlueprint}},identifier:{get:function(){return["blueprint",this.name.toLowerCase()].join("_")}},_binder:{value:null},binder:{serializable:!1,get:function(){return this._binder||(this._binder=BinderModule.Binder.manager.defaultBinder,this._binder.addBlueprint(this)),this._binder},set:function(e){this._binder=e}},_parentReference:{value:null},_parent:{value:null},parent:{serializable:!1,get:function(){return this._parent},set:function(e){e?(this._parentReference=(new BlueprintReference).initWithValue(e),this._parent=e):(this._parentReference=null,this._parent=null)}},moduleId:{value:""},prototypeName:{value:null},customPrototype:{value:!1},_propertyBlueprints:{value:[],distinct:!0},propertyBlueprints:{get:function(){var e=[];return e=e.concat(this._propertyBlueprints),this.parent&&(e=e.concat(this.parent.propertyBlueprints)),e}},_propertyBlueprintsTable:{value:{},distinct:!0,writable:!1},addPropertyBlueprint:{value:function(e){if(null!==e&&null!==e.name){var n=this._propertyBlueprints.indexOf(e);0>n&&(null!==e.owner&&e.owner!==this&&e.owner.removePropertyBlueprint(e),this._propertyBlueprints.push(e),this._propertyBlueprintsTable[e.name]=e,e._owner=this)}return e}},removePropertyBlueprint:{value:function(e){if(null!==e&&null!==e.name){var n=this._propertyBlueprints.indexOf(e);n>=0&&(this._propertyBlueprints.splice(n,1),delete this._propertyBlueprintsTable[e.name],e._owner=null)}return e}},newPropertyBlueprint:{value:function(e,n){return(new PropertyBlueprint).initWithNameBlueprintAndCardinality(e,this,n)}},newAssociationBlueprint:{value:function(e,n){return(new AssociationBlueprint).initWithNameBlueprintAndCardinality(e,this,n)}},newDerivedPropertyBlueprint:{value:function(e,n){return(new DerivedPropertyBlueprint).initWithNameBlueprintAndCardinality(e,this,n)}},addToOnePropertyBlueprintNamed:{value:function(e){return this.addPropertyBlueprint(this.newPropertyBlueprint(e,1))}},addToManyPropertyBlueprintNamed:{value:function(e){return this.addPropertyBlueprint(this.newPropertyBlueprint(e,1/0))}},addToOneAssociationBlueprintNamed:{value:function(e,n){var t=this.addPropertyBlueprint(this.newAssociationBlueprint(e,1));return n&&(t.targetBlueprint=n.owner,n.targetBlueprint=this),t}},addToManyAssociationBlueprintNamed:{value:function(e,n){var t=this.addPropertyBlueprint(this.newAssociationBlueprint(e,1/0));return n&&(t.targetBlueprint=n.owner,n.targetBlueprint=this),t}},propertyBlueprintForName:{value:function(e){var n=this._propertyBlueprintsTable[e];if(n===void 0){n=UnknownPropertyBlueprint;var t,s;for(s=0;(t=this._propertyBlueprints[s])!==void 0;s++)if(t.name===e){n=t;break}this._propertyBlueprintsTable[e]=n}return n===UnknownPropertyBlueprint&&(n=null),!n&&this.parent&&(n=this.parent.propertyBlueprintForName(e)),n}},_propertyBlueprintGroups:{distinct:!0,value:{}},propertyBlueprintGroups:{get:function(){var e=[];for(var n in this._propertyBlueprintGroups)e.push(n);return this.parent&&(e=e.concat(this.parent.propertyBlueprintGroups)),e}},propertyBlueprintGroupForName:{value:function(e){var n=this._propertyBlueprintGroups[e];return!n&&this.parent&&(n=this.parent.propertyBlueprintGroupForName(e)),null!=n?n:[]}},addPropertyBlueprintGroupNamed:{value:function(e){var n=this._propertyBlueprintGroups[e];return null==n&&(n=[],this._propertyBlueprintGroups[e]=n),n}},removePropertyBlueprintGroupNamed:{value:function(e){var n=this._propertyBlueprintGroups[e];return null!=n&&delete this._propertyBlueprintGroups[e],n}},addPropertyBlueprintToGroupNamed:{value:function(e,n){var t=this._propertyBlueprintGroups[n];null==t&&(t=this.addPropertyBlueprintGroupNamed(n));var s=t.indexOf(e);return 0>s&&t.push(e),t}},removePropertyBlueprintFromGroupNamed:{value:function(e,n){var t=this._propertyBlueprintGroups[n];if(null!=t&&null!=e){var s=t.indexOf(e);s>=0&&t.splice(s,1)}return null!=t?t:[]}},_eventBlueprints:{value:[],distinct:!0},eventBlueprints:{get:function(){var e=[];return e=e.concat(this._eventBlueprints),this.parent&&(e=e.concat(this.parent.eventBlueprints)),e}},_eventBlueprintsTable:{value:{},distinct:!0,writable:!1},addEventBlueprint:{value:function(e){if(null!==e&&null!==e.name){var n=this._eventBlueprints.indexOf(e);0>n&&(null!==e.owner&&e.owner!==this&&e.owner.removeEventBlueprint(e),this._eventBlueprints.push(e),this._eventBlueprintsTable[e.name]=e,e._owner=this)}return e}},removeEventBlueprint:{value:function(e){if(null!==e&&null!==e.name){var n=this._eventBlueprints.indexOf(e);n>=0&&(this._eventBlueprints.splice(n,1),delete this._eventBlueprintsTable[e.name],e._owner=null)}return e}},newEventBlueprint:{value:function(e){return(new EventBlueprint).initWithNameAndBlueprint(e,this)}},addEventBlueprintNamed:{value:function(e){return this.addEventBlueprint(this.newEventBlueprint(e))}},eventBlueprintForName:{value:function(e){var n=this._eventBlueprintsTable[e];if(n===void 0){n=UnknownEventBlueprint;var t,s;for(s=0;(t=this._eventBlueprints[s])!==void 0;s++)if(t.name===e){n=t;break}this._eventBlueprintsTable[e]=n}return n===UnknownEventBlueprint&&(n=null),!n&&this.parent&&(n=this.parent.eventBlueprintForName(e)),n}},_propertyValidationRules:{value:{}},propertyValidationRules:{get:function(){var e=[];for(var n in this._propertyValidationRules)e.push(this._propertyValidationRules[n]);return this.parent&&(e=e.concat(this.parent.propertyValidationRules)),e}},propertyValidationRuleForName:{value:function(e){var n=this._propertyValidationRules[e];return!n&&this.parent&&(n=this.parent.propertyValidationRuleForName(e)),n}},addPropertyValidationRule:{value:function(e){var n=this._propertyValidationRules[e];return null==n&&(n=(new PropertyValidationRule).initWithNameAndBlueprint(e,this),this._propertyValidationRules[e]=n),n}},removePropertyValidationRule:{value:function(e){var n=this._propertyValidationRules[e];return null!=n&&delete this._propertyValidationRules[e],n}},evaluateRules:{value:function(e){var n=[];for(var t in this._propertyValidationRules){var s=this._propertyValidationRules[t];s.evaluateRule(e)&&n.push(s.messageKey)}return n}},blueprintModuleId:require("montage")._blueprintModuleIdDescriptor,blueprint:require("montage")._blueprintDescriptor},{getBlueprintWithModuleId:{value:function(e,n){if(!n)throw Error("Require needed to get blueprint "+e);return n.async(e).then(function(t){return n=getModuleRequire(n,e),(new Deserializer).init(JSON.stringify(t),n).deserializeObject()}).then(function(t){if(!t)throw Error("No Blueprint found for "+e);var s=t._binder?t._binder:BinderModule.Binder.manager.defaultBinder;if(n.location===s.require.location){var a=s.blueprintForPrototype(t.prototypeName,t.moduleId);if(a)return a;s.addBlueprint(t)}return t.blueprintInstanceModuleId=e,t._parentReference?t._parentReference.promise(n).then(function(e){return t._parent=e,t},function(e){throw Error("Cannot resolve parent blueprint "+t._parentReference+" because "+e)}):t}).fail(function(n){var t=Error("Error deserializing Blueprint "+e+" because "+n.message);throw t.error=n,t})}}}),UnknownBlueprint=Object.freeze((new Blueprint).initWithName("Unknown")),UnknownPropertyBlueprint=Object.freeze((new PropertyBlueprint).initWithNameBlueprintAndCardinality("Unknown",null,1)),UnknownEventBlueprint=Object.freeze((new EventBlueprint).initWithNameAndBlueprint("Unknown",null));