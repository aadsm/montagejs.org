var Montage=require("core/core").Montage,MontageLabeler=require("./serializer/montage-labeler").MontageLabeler,MontageReviver=require("./deserializer/montage-reviver").MontageReviver,parse=require("frb/parse"),stringify=require("frb/stringify"),Serialization=Montage.specialize({_serializationString:{value:null},_serializationObject:{value:null},initWithString:{value:function(e){return this._serializationString=e,this._serializationObject=null,this}},initWithObject:{value:function(e){return this._serializationString=null,this._serializationObject=e,this}},getSerializationObject:{value:function(){return this._serializationObject||(this._serializationObject=JSON.parse(this._serializationString)),this._serializationObject}},getSerializationString:{value:function(){return this._serializationString||(this._serializationString=JSON.stringify(this._serializationObject)),this._serializationString}},getSerializationLabels:{value:function(){var e=this.getSerializationObject();return Object.keys(e)}},getExternalObjectLabels:{value:function(){var e=this.getSerializationObject(),n=[];for(var s in e)0===Object.keys(e[s]).length&&n.push(s);return n}},isExternalObject:{value:function(e){var n=this.getSerializationObject();return e in n?0===Object.keys(n[e]).length:!1}},getSerializationLabelsWithElements:{value:function(e){var n=new SerializationInspector,s=[];return n.initWithSerialization(this),n.visitSerialization(function(n){"Element"===n.type&&e.indexOf(n.data)>=0&&(n=n.parent,n&&"properties"===n.name&&(n=n.parent,n&&"montageObject"===n.type&&s.push(n.label)))}),s}},renameElementReferences:{value:function(e){var n=new SerializationInspector;n.initWithSerialization(this),n.visitSerialization(function(n){"Element"===n.type&&n.data in e&&(n.data=e[n.data])})}},renameSerializationLabels:{value:function(e){var n=new SerializationInspector;n.initWithSerialization(this),n.visitSerialization(function(n){if(n.label){var s=n.label;s in e&&(n.label=e[s])}if("reference"===n.type){var a=n.data;a in e&&(n.data=e[a])}})}},mergeSerialization:{value:function(e){return SerializationMerger.mergeSerializations(this,e)}},extractSerialization:{value:function(e,n){var s=new SerializationExtractor;return s.initWithSerialization(this),s.extractSerialization(e,n)}}}),SerializationMerger=Montage.specialize(null,{mergeSerializations:{value:function(e,n){var s,a,t,o,i,p;o=e.getSerializationLabels(),i=n.getSerializationLabels(),p=this._createCollisionTable(o,i),p&&(t=n.getSerializationString(),n=(new Serialization).initWithString(t),n.renameSerializationLabels(p),i=n.getSerializationLabels()),s=e.getSerializationObject(),a=n.getSerializationObject();for(var r,l=0;r=i[l];l++)s[r]=a[r];return e.initWithObject(s),p}},_createCollisionTable:{value:function(e,n){for(var s=new MontageLabeler,a={},t=!1,o=0;e.length>o;o++)s.setObjectLabel(null,e[o]);for(var i,o=0;i=n[o];o++)e.indexOf(i)>=0&&(a[i]=s.generateObjectLabel({}),t=!0);return t?a:void 0}}}),SerializationInspector=Montage.specialize({initWithSerialization:{value:function(e){this._serialization=e}},visitSerialization:{value:function(e){var n=this._serialization.getSerializationObject();this._walkRootObjects(e,n),this._serialization.initWithObject(n)}},visitSerializationObject:{value:function(e,n){var s=this._serialization.getSerializationObject();if(!(e in s))throw Error('Object "'+e+'" does not exist in '+this._serialization.getSerializationString());this._walkRootObject(n,s,e),this._serialization.initWithObject(s)}},changeLabel:{value:function(e,n){var s,a=this._serialization.getSerializationObject();s=a[e],delete a[e],a[n]=s}},_walkRootObjects:{value:function(e,n){for(var s in n)this._walkRootObject(e,n,s)}},_walkRootObject:{value:function(e,n,s){var a=n[s];"value"in a?this._walkObject(e,a,"value",s):this._walkCustomObject(e,n,s)}},_walkObject:{value:function(e,n,s,a,t){var o,i=n[s],p=MontageReviver.getTypeOf(i);if(o={type:p},a?o.label=a:o.name=s,t&&(o.parent=t),"number"===p||"string"===p||"null"===p)o.data=i,e(o),n[s]=o.data;else if("regexp"===p)o.data=i["/"],e(o),i["/"]=o.data;else if("reference"===p)o.data=i["@"],e(o),i["@"]=o.data;else if("Element"===p)o.data=i["#"],e(o),i["#"]=o.data;else if("array"===p){o.data=i,e(o),n[s]=i=o.data;for(var r=0,l=i.length;l>r;r++)this._walkObject(e,i,""+r,null,o)}else if("object"===p){o.data=i,e(o),n[s]=i=o.data;for(var s in i)this._walkObject(e,i,s,null,o)}o.label!=a&&this.changeLabel(a,o.label)}},_walkCustomObject:{value:function(e,n,s){var a,t=n[s];a={type:"montageObject",label:s,data:t},e(a),n[s]=t=a.data,a.label!=s&&this.changeLabel(s,a.label),t.properties&&this._walkObject(e,t,"properties",null,a),t.listeners&&this._walkObject(e,t,"listeners",null,a),t.bindings&&this._walkBindings(e,t,null,a),t.localizations&&this._walkLocalizations(e,t,null,a)}},_walkBindings:{value:function(e,n,s){var a,t=n.bindings;a={type:"bindings",data:t,parent:s},e(a),n.bindings=t=a.data;for(var o in t)this._walkBinding(e,t,o,a)}},_walkBinding:{value:function(e,n,s,a){var t,o=n[s];t={type:"binding",name:s,data:o,parent:a},e(t),n[s]=o=t.data,this._walkBindingData(e,o,t)}},_walkBindingData:{value:function(e,n,s){var a,t,o=!1;a=n["<-"]||n["<->"],t=parse(a),this._walksBindingReferences(t,function(n){var s={type:"reference",data:n.label};e(s),n.label!==s.data&&(n.label=s.data,o=!0)}),o&&("<-"in n?n["<-"]=stringify(t):n["<->"]=stringify(t)),n.converter&&this._walkObject(e,n,"converter",null,s)}},_walkLocalizations:{value:function(e,n,s){var a,t=n.localizations;a={type:"localizations",data:t,parent:s},e(a),n.localizations=t=a.data;for(var o in t)this._walkLocalization(e,t,o,a)}},_walkLocalization:{value:function(e,n,s,a){var t,o,i=n[s];if(t={type:"localization",name:s,data:i,parent:a},e(t),n[s]=i=t.data,"object"==typeof i.key&&this._walkBindingData(e,i.key,t),"object"==typeof i.default&&this._walkBindingData(e,i.default,t),"object"==typeof i.data){o=i.data;for(var s in o)this._walkBindingData(e,o[s],t)}}},_walksBindingReferences:{value:function(e,n){var s=e.args;if("component"===e.type&&n(e),s)for(var a=0,t=s.length;t>a;a++)this._walksBindingReferences(s[a],n)}}}),SerializationExtractor=Montage.specialize({_serialization:{value:null},initWithSerialization:{value:function(e){this._serialization=e}},extractSerialization:{value:function(e,n){var s,a=new SerializationInspector,t={},o=[];s=this._serialization.getSerializationObject(),a.initWithSerialization(this._serialization);for(var i,p=0;i=e[p];p++)t[i]=s[i],a.visitSerializationObject(i,function(n){var s;"reference"===n.type&&(s=n.data,-1===o.indexOf(s)&&-1===e.indexOf(s)&&o.push(s))});if(n)for(var i,p=0;i=n[p];p++)i in s&&!(i in t)&&(t[i]={});for(var i,p=0;i=o[p];p++)t[i]={};return(new Serialization).initWithObject(t)}}});exports.Serialization=Serialization,exports.SerializationMerger=SerializationMerger,exports.SerializationInspector=SerializationInspector,exports.SerializationExtractor=SerializationExtractor;