montageDefine("84c41d8","core/template",{dependencies:["montage","core/serialization","core/document-part","core/document-resources","core/serialization/serialization","core/serialization/serializer/montage-labeler","core/promise","core/logger","core/event/event-manager","core/application"],factory:function(e,n){function t(e,n,t){var s,a,o=new u,r=e.documentElement.outerHTML,l=new i,p=e.documentElement;return s=o.createHtmlDocumentWithHtml(r),o.initWithDocument(s,n).then(function(){return o.setBaseUrl(e.location.href),a=o._createTemplateObjects(t),l.initWithTemplateAndFragment(o),o._instantiateObjects(a,p).then(function(e){return l.objects=e,o._invokeDelegates(l),l})})}var s,a=e("montage").Montage,o=e("core/serialization").Deserializer,i=e("core/document-part").DocumentPart,r=e("core/document-resources").DocumentResources,l=e("core/serialization/serialization").Serialization,p=e("core/serialization/serializer/montage-labeler").MontageLabeler,c=e("core/promise").Promise;e("core/logger").logger("template"),e("core/event/event-manager").defaultEventManager;var u=a.specialize({_SERIALIZATON_SCRIPT_TYPE:{value:"text/montage-serialization"},_ELEMENT_ID_ATTRIBUTE:{value:"data-montage-id"},PARAM_ATTRIBUTE:{value:"data-param"},_require:{value:null},_resources:{value:null},document:{value:null},_baseUrl:{value:null},_instances:{value:null},_metadata:{value:null},_objectsString:{value:null},objectsString:{get:function(){return this._objectsString},set:function(e){this._objectsString=e,this._serialization&&this._serialization.initWithString(e),this.__deserializer=null}},__deserializer:{value:null},_deserializer:{get:function(){var e,n,t=this.__deserializer;if(!t){if(e=this._metadata){n=Object.create(null);for(var s in e)n[s]=e[s].require}t=(new o).init(this.objectsString,this._require,n),this.__deserializer=t}return t}},getDeserializer:{value:function(){return this._deserializer}},_serialization:{value:null},getSerialization:{value:function(){var e=this._serialization;return e||(e=this._serialization=new l,e.initWithString(this.objectsString)),e}},constructor:{value:function u(){this.super()}},initWithRequire:{value:function(e){return this._require=e,this.document=this.createHtmlDocumentWithHtml(""),this.objectsString="",this}},initWithDocument:{value:function(e,n){var t=this;return this._require=n,this.setDocument(e),this.getObjectsString(e).then(function(e){return t.objectsString=e,t})}},initWithHtml:{value:function(e,n){var t=this;return this._require=n,this.document=this.createHtmlDocumentWithHtml(e),this.getObjectsString(this.document).then(function(e){return t.objectsString=e,t})}},initWithObjectsAndDocumentFragment:{value:function(e,n,t){return this._require=t,this.document=this.createHtmlDocumentWithHtml(""),this.document.body.appendChild(this.document.importNode(n,!0)),this.setObjects(e),this}},initWithModuleId:{value:function(e,n){var t=this;return this._require=n,this.createHtmlDocumentWithModuleId(e,n).then(function(s){var a=n(e).directory;return t.document=s,t.setBaseUrl(a),t.getObjectsString(s).then(function(e){return t.objectsString=e,t})})}},clone:{value:function(){var e=new u;return e._require=this._require,e._baseUrl=this._baseUrl,e.setDocument(this.document),e.objectsString=this.objectsString,e._instances=Object.clone(this._instances,1),e}},instantiate:{value:function(e){return this.instantiateWithInstances(null,e)}},instantiateWithInstances:{value:function(e,n){var t,s,a,o=this,r=new i;return e=e||this._instances,t=this._createMarkupDocumentFragment(n),a=this._getParameters(t),r.initWithTemplateAndFragment(this,t),r.startActingAsTopComponent(),r.parameters=a,s=this._createTemplateObjects(e),this._instantiateObjects(s,t).then(function(t){var s;return r.objects=t,o._invokeDelegates(r,e),r.stopActingAsTopComponent(),s=o.getResources(),!s.resourcesLoaded()&&s.hasResources()&&s.loadResources(n),r})}},_objectsInstantiationOptimized:{value:!1},_optimizeObjectsInstantiationPromise:{value:null},_optimizeObjectsInstantiation:{value:function(){var e,n=this;return this._objectsInstantiationOptimized?void 0:(this._optimizeObjectsInstantiationPromise||(e=this._deserializer.preloadModules(),e?this._optimizeObjectsInstantiationPromise=e.then(function(){n._objectsInstantiationOptimized=!0}):this._objectsInstantiationOptimized=!0),this._optimizeObjectsInstantiationPromise)}},setBaseUrl:{value:function(e){this._baseUrl=e}},getBaseUrl:{value:function(){return this._baseUrl}},getResources:{value:function(){var e=this._resources;return e||(e=this._resources=new h,e.initWithTemplate(this)),e}},_createTemplateObjects:{value:function(n){var t=Object.create(n||null);return s===void 0&&(s=e("core/application").application),t.application=s,t.template=this,t}},_instantiateObjects:{value:function(e,n){var t,s=this._deserializer;return t=this._optimizeObjectsInstantiation(),t?t.then(function(){return s.deserialize(e,n)}):s.deserialize(e,n)}},_createMarkupDocumentFragment:{value:function(e){for(var n=e.createDocumentFragment(),t=this.document.body.childNodes,s=0,a=t.length;a>s;s++)n.appendChild(e.importNode(t[s],!0));return n}},getParameterName:{value:function(e){return e.getAttribute(this.PARAM_ATTRIBUTE)}},getParameters:{value:function(){return this._getParameters(this.document.body)}},_getParameters:{value:function(e){for(var n,t=e.querySelectorAll("*["+this.PARAM_ATTRIBUTE+"]"),s=t.length,a={},o=0;s>o;o++){n=t[o];var i=this.getParameterName(n);if(i in a)throw Error('The parameter "'+i+'" is'+" declared more than once in "+this.getBaseUrl()+".");a[i]=n}if("*"in a&&s>1)throw Error('The star "*" template parameter was declared when other parameters were also present in '+this.getBaseUrl()+": "+Object.keys(a)+".");return a}},hasParameters:{value:function(){return!!this.document.querySelector("*["+this.PARAM_ATTRIBUTE+"]")}},_invokeDelegates:{value:function(e,n){var t,s,a=e.objects,o=a.owner;for(var i in a)n&&i in n||(t=a[i],s=this._getObjectOwner(i,o),t&&("function"==typeof t._deserializedFromTemplate&&t._deserializedFromTemplate(s,i,e),"function"==typeof t.deserializedFromTemplate&&t.deserializedFromTemplate(s,i,e)));if(o){var r=this.getSerialization();r.isExternalObject("owner")||("function"==typeof o._templateDidLoad&&o._templateDidLoad(e),"function"==typeof o.templateDidLoad&&o.templateDidLoad(e))}}},setInstances:{value:function(e){this._instances=e}},getInstances:{value:function(){return this._instances}},setObjects:{value:function(e){this.objectsString=JSON.stringify(e,null,4)}},setObjectMetadata:{value:function(e,n,t,s){var a=this._metadata;a||(this._metadata=a=Object.create(null)),a[e]={require:n,label:t,owner:s},this.__deserializer=null}},getObjectMetadata:{value:function(e){var n=this._metadata;return n&&e in n?n[e]:{require:this._require,label:e}}},_getObjectOwner:{value:function(e,n){var t,s=this._metadata;return t=s&&e in s?s[e].owner:n}},setDocument:{value:function(e){var n=e.documentElement.innerHTML;this.document=this.createHtmlDocumentWithHtml(n)}},getObjectsString:{value:function(e){var n;return n=this.getInlineObjectsString(e),null===n?this.getExternalObjectsString(e):c.resolve(n)}},getInlineObjectsString:{value:function(e){var n="script[type='"+this._SERIALIZATON_SCRIPT_TYPE+"']",t=e.querySelector(n);return t?t.textContent:null}},getExternalObjectsString:{value:function(e){var n,t,s,a,o=e.querySelector('link[rel="serialization"]');return o?(n=new XMLHttpRequest,t=o.getAttribute("href"),s=this.getBaseUrl()||"",/^https?:\/\/|^\//.test(t)?c.reject(Error("Relative link found for the objects file but the document URL is unknown: '"+t+"'.")):(t=s+t,a=c.defer(),n.open("GET",t),n.addEventListener("load",function(){200==n.status?a.resolve(n.responseText):a.reject(Error("Unable to retrive '"+t+"', code status: "+n.status))},!1),n.addEventListener("error",function(e){a.reject(Error("Unable to retrive '"+t+"' with error: "+e.error+"."))},!1),n.send(),a.promise)):c.resolve(null)}},createHtmlDocumentWithHtml:{value:function(e){var n=document.implementation.createHTMLDocument("");return n.documentElement.innerHTML=e,n}},createHtmlDocumentWithModuleId:{value:function(e,n){var t=this;return"function"!=typeof n?c.reject(Error("Missing 'require' function to load module '"+e+"'.")):n.async(e).then(function(e){return t.createHtmlDocumentWithHtml(e.content)})}},_removeObjects:{value:function(e){var n="script[type='"+this._SERIALIZATON_SCRIPT_TYPE+"'], link[rel='serialization']";Array.prototype.forEach.call(e.querySelectorAll(n),function(e){e.parentNode.removeChild(e)})}},_addObjects:{value:function(e,n){if(n){var t=e.createElement("script");t.setAttribute("type",this._SERIALIZATON_SCRIPT_TYPE),t.textContent=JSON.stringify(JSON.parse(n),null,4),e.head.appendChild(t)}}},_templateFromElementContentsCache:{value:null},clearTemplateFromElementContentsCache:{value:function(){this._templateFromElementContentsCache=null}},createTemplateFromElementContents:{value:function(e){var n,t,s,a=this._templateFromElementContentsCache;return a||(a=Object.create(null),this._templateFromElementContentsCache=a),e in a?Object.create(a[e]):(n=this.getElementById(e),s=this.document.createRange(),s.selectNodeContents(n),t=this.createTemplateFromRange(s),a[e]=t,Object.create(t))}},createTemplateFromElement:{value:function(e){var n,t;return n=this.getElementById(e),t=this.document.createRange(),t.selectNode(n),this.createTemplateFromRange(t)}},createTemplateFromRange:{value:function(e){var n,t,s,a,o,i=new l;return n=e.cloneContents(),t=this._getChildrenElementIds(n),i.initWithString(this.objectsString),s=i.getSerializationLabelsWithElements(t),o=i.extractSerialization(s,["owner"]),a=new u,a.initWithObjectsAndDocumentFragment(null,n,this._require),a.objectsString=o.getSerializationString(),a._resources=this.getResources(),a}},_createSerializationWithElementIds:{value:function(e){var n,t,s=new l;return s.initWithString(this.objectsString),n=s.getSerializationLabelsWithElements(e),t=s.extractSerialization(n,["owner"])}},expandParameters:{value:function(e,n){var t,s,a,o,i,r,l=[],p={},c=this.getSerialization(),u={};t=this.getParameters();for(var h in t)if(o=t[h],i=n.getTemplateParameterArgument(e,h),l.push.apply(l,this._getElementIds(i)),s=this.replaceNode(i,o))for(var d in s)p[d]=s[d];return u.elementIds=l,u.elementIdsCollisions=p,r=e._createSerializationWithElementIds(l),r.renameElementReferences(p),a=c.mergeSerialization(r),this.objectsString=c.getSerializationString(),u.labels=r.getSerializationLabels(),u.labelsCollisions=a,u}},_resolveElementIdCollisions:{value:function(e){var n,t,s,a,o,i=new p;s=this.getElementIds();for(var r,l=0;r=s[l];l++)i.setObjectLabel(null,r);t=this._getElements(e);for(var r in t)this.getElementById(r)&&(a=t[r],o=i.getObjectLabel(a),this.setElementId(a,o),n||(n=Object.create(null)),n[r]=o);return n}},replaceNode:{value:function(e,n){var t;return t=this._resolveElementIdCollisions(e),n.parentNode.replaceChild(e,n),t}},insertNodeBefore:{value:function(e,n){var t;return t=this._resolveElementIdCollisions(e),n.parentNode.insertBefore(e,n),t}},appendNode:{value:function(e,n){var t;return t=this._resolveElementIdCollisions(e),n.appendChild(e),t}},getElementId:{value:function(e){return e.getAttribute?e.getAttribute(this._ELEMENT_ID_ATTRIBUTE):void 0}},setElementId:{value:function(e,n){e.setAttribute(this._ELEMENT_ID_ATTRIBUTE,n)}},getElementIds:{value:function(){return this._getElementIds(this.document.body)}},_getElements:{value:function(e){var n,t,s="*["+this._ELEMENT_ID_ATTRIBUTE+"]",a={};n=e.querySelectorAll(s);for(var o,i=0;o=n[i];i++)t=this.getElementId(o),a[t]=o;return t=this.getElementId(e),t&&(a[t]=e),a}},_getChildrenElementIds:{value:function(e){var n,t="*["+this._ELEMENT_ID_ATTRIBUTE+"]",s=[];n=e.querySelectorAll(t);for(var a,o=0;a=n[o];o++)s.push(this.getElementId(a));return s}},_getElementIds:{value:function(e){var n,t=this._getChildrenElementIds(e);return n=this.getElementId(e),n&&t.push(n),t}},getElementById:{value:function(e){var n="*["+this._ELEMENT_ID_ATTRIBUTE+"='"+e+"']";return this.document.querySelector(n)}},html:{get:function(){var e=this.document;return this._removeObjects(e),this._addObjects(e,this.objectsString),this._getDoctypeString(e.doctype)+"\n"+e.documentElement.outerHTML}},_getDoctypeString:{value:function(e){return"<!DOCTYPE "+e.name+(e.publicId?' PUBLIC "'+e.publicId+'"':"")+(!e.publicId&&e.systemId?" SYSTEM":"")+(e.systemId?' "'+e.systemId+'"':"")+">"}}},{_templateCache:{value:{moduleId:Object.create(null)}},_getTemplateCacheKey:{value:function(e,n){return e=n.resolve(e),n.location+"#"+e}},getTemplateWithModuleId:{value:function(e,n){var t,s;return t=this._getTemplateCacheKey(e,n),s=this._templateCache.moduleId[t],s||(s=(new u).initWithModuleId(e,n),this._templateCache.moduleId[t]=s),s}}}),h=a.specialize({_resources:{value:null},_resourcesLoaded:{value:!1},template:{value:null},rootUrl:{value:""},constructor:{value:function h(){this._resources=Object.create(null)}},initWithTemplate:{value:function(e){this.template=e}},hasResources:{value:function(){return this.getStyles().length>0||this.getScripts().length>0}},resourcesLoaded:{value:function(){return this._resourcesLoaded}},loadResources:{value:function(e){return this._resourcesLoaded=!0,c.all([this.loadScripts(e),this.loadStyles(e)])}},getScripts:{value:function(){var e,n,t,s=this._resources.scripts;if(!s){n=this.template,s=this._resources.scripts=[],t=n.document.querySelectorAll("script");for(var a=0,o=t.length;o>a;a++)e=t[a],e.type!==this.template._SERIALIZATON_SCRIPT_TYPE&&s.push(e)}return s}},loadScripts:{value:function(e){var n,t=[];n=this.getScripts();for(var s=0,a=n.length;a>s;s++)t.push(this.loadScript(n[s],e));return c.all(t)}},loadScript:{value:function(e,n){var t,s;return t=r.getInstanceForDocument(n),s=this._cloneScriptElement(e,n),t.addScript(s)}},_cloneScriptElement:{value:function(e,n){for(var t,s=n.createElement("script"),a=e.attributes,o=0,i=a.length;i>o;o++)t=a[o],s.setAttribute(t.name,t.value);return s}},getStyles:{value:function(){var e,n,t,s=this._resources.styles;return s||(t='link[rel="stylesheet"], style',e=this.template,n=e.document.querySelectorAll(t),s=Array.prototype.slice.call(n,0),this._resources.styles=s),s}},loadStyles:{value:function(e){var n,t=[];n=this.getStyles();for(var s=0,a=n.length;a>s;s++)t.push(this.loadStyle(n[s],e));return c.all(t)}},loadStyle:{value:function(e,n){var t,s,a=this.template.getBaseUrl();return t=e.getAttribute("href"),t?(s=r.getInstanceForDocument(n),t=s.normalizeUrl(t,a),s.preloadResource(t)):c.resolve()}},createStylesForDocument:{value:function(e){var n,t,s,a,o=this.getStyles(),i=[],l=this.template.getBaseUrl();t=r.getInstanceForDocument(e);for(var p,c=0;p=o[c];c++)s=p.getAttribute("href"),n=e.importNode(p,!0),i.push(n),s&&(a=t.normalizeUrl(s,l),n.setAttribute("href",a));return i}}});n.Template=u,n.TemplateResources=h,n.instantiateDocument=t}});